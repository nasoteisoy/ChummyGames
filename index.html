<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Firebase Collect Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body { margin:0; background:#20262e; color:white; font-family:Arial; text-align:center; }
  #controls { margin-top:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  input,button { padding:8px; border-radius:6px; border:none; }
  #gameCanvas { background:#111; margin-top:10px; touch-action:none; }
  #joystickArea { position:fixed; bottom:20px; left:20px; width:140px; height:140px;
    background:rgba(255,255,255,0.05); border-radius:50%; touch-action:none; }
  #joystick { position:absolute; width:60px; height:60px; background:rgba(255,255,255,0.3);
    border-radius:50%; left:40px; top:40px; pointer-events:none; }
  #winModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.8); z-index:100; }
  #winContent { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    background:#2a3138; padding:30px; border-radius:12px; text-align:center; }
  #winContent h2 { margin:0 0 20px 0; font-size:2em; }
  #winContent button { padding:12px 24px; font-size:1.1em; cursor:pointer; 
    background:#33aaff; color:white; border:none; border-radius:6px; }
  #winContent button:hover { background:#2288dd; }
  .info-box { background:#2a3138; padding:10px; border-radius:6px; margin:5px; display:inline-block; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

<h2>Collect the Yellow Blocks - First to 50 Wins!</h2>
<div id="status">Initializingâ€¦</div>

<div id="controls">
  <div class="info-box">Your ID: <span id="myId"></span></div>
  <input id="roomCodeInput" placeholder="Room Code (4 chars)" maxlength="4" style="text-transform:uppercase;">
  <button id="createRoomBtn">Create Room</button>
  <button id="joinRoomBtn">Join Room</button>
</div>

<canvas id="gameCanvas"></canvas>

<div id="joystickArea"><div id="joystick"></div></div>

<div id="winModal">
  <div id="winContent">
    <h2 id="winMessage"></h2>
    <p id="finalScore"></p>
    <button id="restartBtn">Play Again</button>
  </div>
</div>

<script>
/* ---------------- Firebase Setup ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDVbt_8GuRuHJRPAN7jFXXbs_lJUfUHNxHE",
  authDomain: "chummy-games.firebaseapp.com",
  databaseURL: "https://chummy-games-default-rtdb.firebaseio.com",
  projectId: "chummy-games",
  storageBucket: "chummy-games.firebasestorage.app",
  messagingSenderId: "869241598273",
  appId: "1:869241598273:web:d97492b7308f785c37f1c0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------------- Player ID Management ---------------- */
function getOrCreatePCID() {
  const storageKey = 'ChummyGames-PC-ID';
  let pcID = localStorage.getItem(storageKey);
  
  if (!pcID || pcID.length !== 12) {
    pcID = generateCode(12);
    localStorage.setItem(storageKey, pcID);
  }
  return pcID;
}

function generateCode(length) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  return Array.from({ length }, () => 
    chars[Math.floor(Math.random() * chars.length)]
  ).join('');
}

const myPCID = getOrCreatePCID();
let roomCode = null;
let myRole = null; // 'player1' or 'player2'
let roomRef = null;
let gameRef = null;

/* ---------------- Canvas ---------------- */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
function resize() {
  canvas.width = window.innerWidth * 0.95;
  canvas.height = window.innerHeight * 0.55;
}
resize();
window.onresize = resize;

/* ---------------- Game State ---------------- */
const state = {
  size:40,
  speed:3,
  gameOver:false,
  myScore:0,
  opponentScore:0,
  my:{x:50,y:50,color:"#33aaff"},
  opponent:{x:200,y:150,color:"#ff4444"},
  block:{x:150,y:100,size:25}
};

const WIN_SCORE = 50;

/* ---------------- UI Elements ---------------- */
const statusEl = document.getElementById("status");
const myIdSpan = document.getElementById("myId");
const roomCodeInput = document.getElementById("roomCodeInput");
const createRoomBtn = document.getElementById("createRoomBtn");
const joinRoomBtn = document.getElementById("joinRoomBtn");
const winModal = document.getElementById("winModal");
const winMessage = document.getElementById("winMessage");
const finalScore = document.getElementById("finalScore");
const restartBtn = document.getElementById("restartBtn");

myIdSpan.textContent = myPCID;
statusEl.textContent = "Ready to play!";

/* ---------------- Room Management ---------------- */
createRoomBtn.onclick = async () => {
  roomCode = generateCode(4);
  roomCodeInput.value = roomCode;
  myRole = 'player1';
  
  roomRef = db.ref(`collectGame/rooms/${roomCode}`);
  
  // Initialize room
  await roomRef.set({
    player1: myPCID,
    player2: null,
    status: 'waiting',
    createdAt: Date.now()
  });
  
  statusEl.textContent = `Room created: ${roomCode}. Waiting for opponent...`;
  createRoomBtn.disabled = true;
  joinRoomBtn.disabled = true;
  
  // Listen for player 2 joining
  roomRef.on('value', (snapshot) => {
    const room = snapshot.val();
    if (room && room.player2 && room.status === 'playing') {
      startGame();
    }
  });
};

joinRoomBtn.onclick = async () => {
  const code = roomCodeInput.value.trim().toUpperCase();
  if (!code || code.length !== 4) {
    return alert("Enter a 4-character room code");
  }
  
  roomCode = code;
  roomRef = db.ref(`collectGame/rooms/${roomCode}`);
  
  const snapshot = await roomRef.once('value');
  const room = snapshot.val();
  
  if (!room) {
    return alert("Room not found!");
  }
  
  if (room.player2) {
    return alert("Room is full!");
  }
  
  myRole = 'player2';
  
  // Join room
  await roomRef.update({
    player2: myPCID,
    status: 'playing'
  });
  
  statusEl.textContent = `Joined room: ${roomCode}`;
  createRoomBtn.disabled = true;
  joinRoomBtn.disabled = true;
  
  startGame();
};

function startGame() {
  gameRef = db.ref(`collectGame/games/${roomCode}`);
  
  // Initialize game state if player1
  if (myRole === 'player1') {
    gameRef.set({
      block: {x: 150, y: 100, size: 25},
      player1: {x: 50, y: 50, score: 0},
      player2: {x: 200, y: 150, score: 0},
      gameOver: false,
      winner: null
    });
  }
  
  statusEl.textContent = "Game started!";
  
  // Listen to game state
  gameRef.on('value', (snapshot) => {
    const game = snapshot.val();
    if (!game) return;
    
    const otherRole = myRole === 'player1' ? 'player2' : 'player1';
    
    state.opponent.x = game[otherRole].x;
    state.opponent.y = game[otherRole].y;
    state.opponentScore = game[otherRole].score;
    state.block = game.block;
    state.gameOver = game.gameOver;
    
    // Check if game just ended
    if (game.gameOver && !winModal.style.display) {
      const didWin = game.winner === myRole;
      showWinScreen(didWin);
    }
  });
}

function updateMyPosition() {
  if (!gameRef || state.gameOver) return;
  
  gameRef.child(myRole).update({
    x: state.my.x,
    y: state.my.y,
    score: state.myScore
  });
}

function updateBlock() {
  if (!gameRef) return;
  gameRef.child('block').set(state.block);
}

/* ---------------- Movement (Joystick + Keyboard) ---------------- */
let joyX=0, joyY=0;
const joyArea=document.getElementById("joystickArea");
const joy=document.getElementById("joystick");

joyArea.addEventListener("touchmove",e=>{
  const r=joyArea.getBoundingClientRect();
  const t=e.touches[0];
  const x=t.clientX-r.left-r.width/2;
  const y=t.clientY-r.top-r.height/2;
  const d=Math.min(Math.sqrt(x*x+y*y),50);
  const a=Math.atan2(y,x);
  joyX=Math.cos(a)*(d/50);
  joyY=Math.sin(a)*(d/50);
  joy.style.left=(40+joyX*40)+"px";
  joy.style.top=(40+joyY*40)+"px";
  e.preventDefault();
});
joyArea.addEventListener("touchend",()=>{
  joyX=joyY=0;
  joy.style.left="40px";
  joy.style.top="40px";
});

const keys={};
onkeydown=e=>keys[e.key]=true;
onkeyup=e=>keys[e.key]=false;

function move(){
  if(state.gameOver) return;
  
  let dx=joyX*state.speed;
  let dy=joyY*state.speed;
  if(keys.ArrowUp||keys.w) dy-=state.speed;
  if(keys.ArrowDown||keys.s) dy+=state.speed;
  if(keys.ArrowLeft||keys.a) dx-=state.speed;
  if(keys.ArrowRight||keys.d) dx+=state.speed;

  state.my.x+=dx;
  state.my.y+=dy;

  state.my.x=Math.max(0,Math.min(canvas.width-state.size,state.my.x));
  state.my.y=Math.max(0,Math.min(canvas.height-state.size,state.my.y));
}

/* ---------------- Block Collecting ---------------- */
function newBlock(){
  state.block.x=Math.random()*(canvas.width-30);
  state.block.y=Math.random()*(canvas.height-30);
}

function checkCollect(){
  if(state.gameOver || !gameRef) return;
  
  const p=state.my;
  const b=state.block;
  if(p.x < b.x+b.size && p.x+state.size > b.x &&
     p.y < b.y+b.size && p.y+state.size > b.y){
    state.myScore++;
    newBlock();
    updateBlock();
    
    // Check for win
    if(state.myScore >= WIN_SCORE){
      gameRef.update({
        gameOver: true,
        winner: myRole
      });
    }
  }
}

function showWinScreen(didWin){
  if(didWin){
    winMessage.textContent="ðŸŽ‰ You Win! ðŸŽ‰";
    winMessage.style.color="#4CAF50";
  } else {
    winMessage.textContent="ðŸ˜” You Lose";
    winMessage.style.color="#ff4444";
  }
  finalScore.textContent=`Final Score: ${state.myScore} - ${state.opponentScore}`;
  winModal.style.display="block";
}

function resetGame(){
  state.myScore=0;
  state.opponentScore=0;
  state.gameOver=false;
  state.my.x=50;
  state.my.y=50;
  state.opponent.x=200;
  state.opponent.y=150;
  newBlock();
  winModal.style.display="none";
  
  if(gameRef){
    gameRef.set({
      block: state.block,
      player1: {x: 50, y: 50, score: 0},
      player2: {x: 200, y: 150, score: 0},
      gameOver: false,
      winner: null
    });
  }
}

restartBtn.onclick = resetGame;

/* ---------------- Draw ---------------- */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // block
  ctx.fillStyle="yellow";
  ctx.fillRect(state.block.x,state.block.y,state.block.size,state.block.size);

  // players
  ctx.fillStyle=state.my.color;
  ctx.fillRect(state.my.x,state.my.y,state.size,state.size);

  ctx.fillStyle=state.opponent.color;
  ctx.fillRect(state.opponent.x,state.opponent.y,state.size,state.size);

  // scores
  ctx.fillStyle="white";
  ctx.font="18px Arial";
  ctx.fillText("You: "+state.myScore+" / "+WIN_SCORE,10,25);
  ctx.fillText("Opponent: "+state.opponentScore+" / "+WIN_SCORE,10,50);
  
  // game over overlay
  if(state.gameOver){
    ctx.fillStyle="rgba(0,0,0,0.5)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="white";
    ctx.font="30px Arial";
    ctx.fillText("Game Over",canvas.width/2-70,canvas.height/2);
  }
}

/* ---------------- Loop ---------------- */
let lastUpdate=0;
function loop(ts){
  move();
  checkCollect();
  draw();

  if(ts-lastUpdate>50 && gameRef){
    updateMyPosition();
    lastUpdate=ts;
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>

</body>
</html>