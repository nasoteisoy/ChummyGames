<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Secret Spy - Social Deduction Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  * { box-sizing: border-box; }
  body { 
    margin:0; 
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color:white; 
    font-family:'Segoe UI', Arial, sans-serif; 
    padding:20px;
    min-height:100vh;
  }
  
  .container { max-width:900px; margin:0 auto; }
  h1 { text-align:center; margin:0 0 30px 0; font-size:2.5em; text-shadow:2px 2px 4px rgba(0,0,0,0.3); }
  
  .card { 
    background:rgba(255,255,255,0.1); 
    backdrop-filter:blur(10px);
    border-radius:12px; 
    padding:20px; 
    margin-bottom:20px;
    border:1px solid rgba(255,255,255,0.2);
  }
  
  input, button { 
    padding:12px 20px; 
    border-radius:8px; 
    border:none; 
    font-size:16px;
    margin:5px;
  }
  
  input {
    background:rgba(255,255,255,0.9);
    color:#333;
  }
  
  button { 
    background:#4CAF50; 
    color:white; 
    cursor:pointer;
    font-weight:bold;
    transition:all 0.3s;
  }
  
  button:hover:not(:disabled) { 
    background:#45a049; 
    transform:translateY(-2px);
    box-shadow:0 4px 8px rgba(0,0,0,0.3);
  }
  
  button:disabled { 
    background:#666; 
    cursor:not-allowed;
    opacity:0.6;
  }
  
  button.danger { background:#f44336; }
  button.danger:hover:not(:disabled) { background:#da190b; }
  
  button.primary { background:#2196F3; }
  button.primary:hover:not(:disabled) { background:#0b7dda; }
  
  .player-list {
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
    gap:10px;
    margin-top:15px;
  }
  
  .player-card {
    background:rgba(255,255,255,0.15);
    padding:15px;
    border-radius:8px;
    border:2px solid transparent;
    transition:all 0.3s;
    cursor:pointer;
  }
  
  .player-card:hover {
    border-color:rgba(255,255,255,0.5);
    transform:scale(1.05);
  }
  
  .player-card.selected {
    border-color:#4CAF50;
    background:rgba(76,175,80,0.3);
  }
  
  .player-card.president {
    border-color:#FFD700;
    background:rgba(255,215,0,0.2);
  }
  
  .player-card.chancellor {
    border-color:#FFA500;
    background:rgba(255,165,0,0.2);
  }
  
  .player-card.dead {
    opacity:0.4;
    filter:grayscale(100%);
    cursor:not-allowed;
  }
  
  .player-name {
    font-weight:bold;
    margin-bottom:5px;
  }
  
  .player-role {
    font-size:12px;
    color:#FFD700;
  }
  
  .role-card {
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding:30px;
    border-radius:12px;
    text-align:center;
    margin:20px 0;
    font-size:1.5em;
    font-weight:bold;
    box-shadow:0 8px 16px rgba(0,0,0,0.3);
  }
  
  .role-card.loyalist {
    background:linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
  }
  
  .role-card.spy {
    background:linear-gradient(135deg, #f44336 0%, #c62828 100%);
  }
  
  .role-card.secret-spy {
    background:linear-gradient(135deg, #9C27B0 0%, #4A148C 100%);
  }
  
  .policy-cards {
    display:flex;
    gap:15px;
    justify-content:center;
    flex-wrap:wrap;
    margin:20px 0;
  }
  
  .policy-card {
    width:120px;
    height:180px;
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    font-size:1.2em;
    cursor:pointer;
    transition:all 0.3s;
    border:3px solid transparent;
  }
  
  .policy-card.loyalist-policy {
    background:linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
  }
  
  .policy-card.spy-policy {
    background:linear-gradient(135deg, #f44336 0%, #c62828 100%);
  }
  
  .policy-card:hover {
    transform:scale(1.1) rotate(5deg);
    box-shadow:0 8px 16px rgba(0,0,0,0.4);
  }
  
  .policy-card.selected {
    border-color:#FFD700;
    transform:scale(1.1);
  }
  
  .board {
    display:flex;
    justify-content:space-around;
    margin:30px 0;
    gap:20px;
  }
  
  .policy-track {
    flex:1;
    background:rgba(0,0,0,0.3);
    padding:20px;
    border-radius:12px;
  }
  
  .track-title {
    text-align:center;
    font-weight:bold;
    margin-bottom:15px;
    font-size:1.2em;
  }
  
  .track-slots {
    display:flex;
    gap:10px;
    justify-content:center;
  }
  
  .track-slot {
    width:50px;
    height:70px;
    border:2px dashed rgba(255,255,255,0.3);
    border-radius:6px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:2em;
  }
  
  .track-slot.filled {
    border:none;
  }
  
  .track-slot.loyalist {
    background:linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
  }
  
  .track-slot.spy {
    background:linear-gradient(135deg, #f44336 0%, #c62828 100%);
  }
  
  .log {
    background:rgba(0,0,0,0.3);
    padding:15px;
    border-radius:8px;
    max-height:200px;
    overflow-y:auto;
    font-size:14px;
  }
  
  .log-entry {
    margin:5px 0;
    padding:5px;
    border-left:3px solid #4CAF50;
    padding-left:10px;
  }
  
  .vote-section {
    text-align:center;
    margin:20px 0;
  }
  
  .vote-buttons {
    display:flex;
    gap:20px;
    justify-content:center;
    margin-top:15px;
  }
  
  .vote-button {
    padding:20px 40px;
    font-size:1.2em;
    border-radius:12px;
  }
  
  .hidden { display:none !important; }
  
  .info-box {
    background:rgba(33,150,243,0.2);
    border-left:4px solid #2196F3;
    padding:15px;
    margin:15px 0;
    border-radius:4px;
  }
  
  .warning-box {
    background:rgba(255,152,0,0.2);
    border-left:4px solid #FF9800;
    padding:15px;
    margin:15px 0;
    border-radius:4px;
  }
  
  .success-box {
    background:rgba(76,175,80,0.2);
    border-left:4px solid #4CAF50;
    padding:15px;
    margin:15px 0;
    border-radius:4px;
  }
  
  #playerIdDisplay {
    text-align:center;
    font-size:0.9em;
    opacity:0.8;
    margin-bottom:20px;
  }
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

<div class="container">
  <h1>üïµÔ∏è Secret Spy üïµÔ∏è</h1>
  <div id="playerIdDisplay"></div>
  
  <!-- Lobby Screen -->
  <div id="lobbyScreen">
    <div class="card">
      <h2>Join or Create Game</h2>
      <div>
        <input id="playerNameInput" placeholder="Your Name" maxlength="20">
        <input id="roomCodeInput" placeholder="Room Code (4 chars)" maxlength="4" style="text-transform:uppercase;">
      </div>
      <div>
        <button id="createRoomBtn" class="primary">Create Room</button>
        <button id="joinRoomBtn" class="primary">Join Room</button>
      </div>
    </div>
    
    <div class="card">
      <h3>How to Play</h3>
      <p><strong>Goal:</strong> Loyalists try to pass 5 Loyalist policies. Spies try to pass 6 Spy policies or assassinate the Secret Spy.</p>
      <p><strong>Roles:</strong></p>
      <ul>
        <li><strong>Loyalists:</strong> Don't know each other, must deduce who to trust</li>
        <li><strong>Spies:</strong> Know each other (except Secret Spy), work together secretly</li>
        <li><strong>Secret Spy:</strong> Special spy that Loyalists must protect</li>
      </ul>
      <p><strong>Gameplay:</strong> Each round, a President nominates a Chancellor. Players vote. If approved, they pass policies from a random draw.</p>
    </div>
  </div>
  
  <!-- Waiting Room -->
  <div id="waitingScreen" class="hidden">
    <div class="card">
      <h2>Room: <span id="roomCodeDisplay"></span></h2>
      <div class="info-box">
        <strong>Players in lobby:</strong>
        <div id="lobbyPlayers" class="player-list"></div>
      </div>
      <div style="text-align:center; margin-top:20px;">
        <button id="startGameBtn" class="hidden" style="font-size:1.2em; padding:15px 40px;">Start Game (5-10 players)</button>
        <button id="leaveRoomBtn" class="danger">Leave Room</button>
      </div>
    </div>
  </div>
  
  <!-- Game Screen -->
  <div id="gameScreen" class="hidden">
    <div class="card">
      <h2>Room: <span id="gameRoomCode"></span></h2>
      
      <!-- Role Display -->
      <div id="roleDisplay"></div>
      
      <!-- Game Board -->
      <div class="board">
        <div class="policy-track">
          <div class="track-title" style="color:#4CAF50;">‚úì Loyalist Policies</div>
          <div class="track-slots" id="loyalistTrack">
            <div class="track-slot" data-index="0"></div>
            <div class="track-slot" data-index="1"></div>
            <div class="track-slot" data-index="2"></div>
            <div class="track-slot" data-index="3"></div>
            <div class="track-slot" data-index="4"></div>
          </div>
        </div>
        
        <div class="policy-track">
          <div class="track-title" style="color:#f44336;">‚úó Spy Policies</div>
          <div class="track-slots" id="spyTrack">
            <div class="track-slot" data-index="0"></div>
            <div class="track-slot" data-index="1"></div>
            <div class="track-slot" data-index="2"></div>
            <div class="track-slot" data-index="3"></div>
            <div class="track-slot" data-index="4"></div>
            <div class="track-slot" data-index="5"></div>
          </div>
        </div>
      </div>
      
      <!-- Game Status -->
      <div id="gameStatus" class="info-box"></div>
      
      <!-- President Actions -->
      <div id="presidentNomination" class="card hidden">
        <h3>You are President! Nominate a Chancellor</h3>
        <div id="nominationPlayers" class="player-list"></div>
        <button id="nominateBtn" class="primary" disabled>Nominate Selected Player</button>
      </div>
      
      <!-- Voting -->
      <div id="votingSection" class="card hidden">
        <h3 id="votingPrompt"></h3>
        <div class="vote-section">
          <div class="vote-buttons">
            <button id="voteYesBtn" class="vote-button" style="background:#4CAF50;">üëç JA (Yes)</button>
            <button id="voteNoBtn" class="vote-button danger">üëé NEIN (No)</button>
          </div>
        </div>
      </div>
      
      <!-- Policy Selection (President) -->
      <div id="presidentPolicySelect" class="card hidden">
        <h3>President: Choose 2 policies to pass to Chancellor</h3>
        <div id="presidentPolicies" class="policy-cards"></div>
        <button id="presidentPassBtn" class="primary" disabled>Pass to Chancellor</button>
      </div>
      
      <!-- Policy Selection (Chancellor) -->
      <div id="chancellorPolicySelect" class="card hidden">
        <h3>Chancellor: Choose 1 policy to enact</h3>
        <div id="chancellorPolicies" class="policy-cards"></div>
        <button id="chancellorEnactBtn" class="primary" disabled>Enact Policy</button>
      </div>
      
      <!-- Executive Action -->
      <div id="executiveAction" class="card hidden">
        <h3 id="executiveActionTitle"></h3>
        <div id="executivePlayers" class="player-list"></div>
        <button id="executeActionBtn" class="primary" disabled>Confirm Action</button>
      </div>
      
      <!-- Players -->
      <div class="card">
        <h3>Players</h3>
        <div id="gamePlayers" class="player-list"></div>
      </div>
      
      <!-- Game Log -->
      <div class="card">
        <h3>Game Log</h3>
        <div id="gameLog" class="log"></div>
      </div>
      
      <div style="text-align:center; margin-top:20px;">
        <button id="leaveGameBtn" class="danger">Leave Game</button>
      </div>
    </div>
  </div>
  
  <!-- Game Over Screen -->
  <div id="gameOverScreen" class="hidden">
    <div class="card">
      <h2 id="gameOverTitle"></h2>
      <div id="gameOverMessage" class="role-card"></div>
      <div id="finalRoles" class="card"></div>
      <div style="text-align:center; margin-top:20px;">
        <button id="newGameBtn" class="primary" style="font-size:1.2em; padding:15px 40px;">New Game</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------- Firebase Setup ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDVbt_8GuRuHJRPAN7jFXXbs_lJUfUHNxHE",
  authDomain: "chummy-games.firebaseapp.com",
  databaseURL: "https://chummy-games-default-rtdb.firebaseio.com",
  projectId: "chummy-games",
  storageBucket: "chummy-games.firebasestorage.app",
  messagingSenderId: "869241598273",
  appId: "1:869241598273:web:d97492b7308f785c37f1c0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------------- Player ID Management ---------------- */
function getOrCreatePCID() {
  const storageKey = 'ChummyGames-PC-ID';
  let pcID = localStorage.getItem(storageKey);
  
  if (!pcID || pcID.length !== 12) {
    pcID = generateCode(12);
    localStorage.setItem(storageKey, pcID);
  }
  return pcID;
}

function generateCode(length) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  return Array.from({ length }, () => 
    chars[Math.floor(Math.random() * chars.length)]
  ).join('');
}

const myPCID = getOrCreatePCID();
let roomCode = null;
let roomRef = null;
let gameRef = null;
let myPlayerData = null;

document.getElementById('playerIdDisplay').textContent = `Your ID: ${myPCID}`;

/* ---------------- Game Constants ---------------- */
const ROLE_DISTRIBUTION = {
  5: { loyalists: 3, spies: 1, secretSpy: 1 },
  6: { loyalists: 4, spies: 1, secretSpy: 1 },
  7: { loyalists: 4, spies: 2, secretSpy: 1 },
  8: { loyalists: 5, spies: 2, secretSpy: 1 },
  9: { loyalists: 5, spies: 3, secretSpy: 1 },
  10: { loyalists: 6, spies: 3, secretSpy: 1 }
};

/* ---------------- UI References ---------------- */
const lobbyScreen = document.getElementById('lobbyScreen');
const waitingScreen = document.getElementById('waitingScreen');
const gameScreen = document.getElementById('gameScreen');
const gameOverScreen = document.getElementById('gameOverScreen');

const playerNameInput = document.getElementById('playerNameInput');
const roomCodeInput = document.getElementById('roomCodeInput');
const createRoomBtn = document.getElementById('createRoomBtn');
const joinRoomBtn = document.getElementById('joinRoomBtn');
const startGameBtn = document.getElementById('startGameBtn');
const leaveRoomBtn = document.getElementById('leaveRoomBtn');
const leaveGameBtn = document.getElementById('leaveGameBtn');

/* ---------------- Create Room ---------------- */
createRoomBtn.onclick = async () => {
  const playerName = playerNameInput.value.trim();
  if (!playerName) return alert('Please enter your name');
  
  roomCode = generateCode(4);
  roomRef = db.ref(`secretSpy/rooms/${roomCode}`);
  
  await roomRef.set({
    host: myPCID,
    status: 'waiting',
    createdAt: Date.now(),
    players: {
      [myPCID]: {
        name: playerName,
        id: myPCID,
        connected: true,
        joinedAt: Date.now()
      }
    }
  });
  
  joinRoom(roomCode, playerName);
};

/* ---------------- Join Room ---------------- */
joinRoomBtn.onclick = async () => {
  const playerName = playerNameInput.value.trim();
  const code = roomCodeInput.value.trim().toUpperCase();
  
  if (!playerName) return alert('Please enter your name');
  if (!code || code.length !== 4) return alert('Please enter a 4-character room code');
  
  const snapshot = await db.ref(`secretSpy/rooms/${code}`).once('value');
  if (!snapshot.exists()) return alert('Room not found!');
  
  const room = snapshot.val();
  if (room.status !== 'waiting') return alert('Game already in progress!');
  
  const playerCount = Object.keys(room.players || {}).length;
  if (playerCount >= 10) return alert('Room is full!');
  
  await db.ref(`secretSpy/rooms/${code}/players/${myPCID}`).set({
    name: playerName,
    id: myPCID,
    connected: true,
    joinedAt: Date.now()
  });
  
  joinRoom(code, playerName);
};

function joinRoom(code, playerName) {
  roomCode = code;
  roomRef = db.ref(`secretSpy/rooms/${roomCode}`);
  
  myPlayerData = {
    name: playerName,
    id: myPCID
  };
  
  lobbyScreen.classList.add('hidden');
  waitingScreen.classList.remove('hidden');
  document.getElementById('roomCodeDisplay').textContent = roomCode;
  
  // Listen to room changes
  roomRef.on('value', handleRoomUpdate);
  
  // Handle disconnect
  const playerRef = roomRef.child(`players/${myPCID}`);
  playerRef.onDisconnect().remove();
}

/* ---------------- Handle Room Updates ---------------- */
function handleRoomUpdate(snapshot) {
  const room = snapshot.val();
  if (!room) {
    returnToLobby();
    return;
  }
  
  const players = room.players || {};
  const playerCount = Object.keys(players).length;
  
  // Update lobby players
  const lobbyPlayersDiv = document.getElementById('lobbyPlayers');
  lobbyPlayersDiv.innerHTML = '';
  
  Object.values(players).forEach(player => {
    const div = document.createElement('div');
    div.className = 'player-card';
    div.innerHTML = `<div class="player-name">${player.name}</div>`;
    if (player.id === room.host) {
      div.innerHTML += '<div class="player-role">üëë Host</div>';
    }
    lobbyPlayersDiv.appendChild(div);
  });
  
  // Show start button if host and enough players
  if (room.host === myPCID && playerCount >= 5 && playerCount <= 10) {
    startGameBtn.classList.remove('hidden');
  } else {
    startGameBtn.classList.add('hidden');
  }
  
  // Check if game started
  if (room.status === 'playing') {
    startGame();
  }
}

/* ---------------- Start Game ---------------- */
startGameBtn.onclick = async () => {
  const snapshot = await roomRef.once('value');
  const room = snapshot.val();
  const players = Object.values(room.players);
  const playerCount = players.length;
  
  // Assign roles
  const roles = assignRoles(playerCount);
  const shuffledPlayers = shuffleArray([...players]);
  
  const gameState = {
    status: 'playing',
    phase: 'nomination',
    round: 1,
    presidentIndex: 0,
    failedVotes: 0,
    loyalistPolicies: 0,
    spyPolicies: 0,
    deck: shuffleDeck(),
    discard: [],
    players: {},
    log: [],
    currentPresident: shuffledPlayers[0].id,
    currentChancellor: null,
    lastPresident: null,
    lastChancellor: null,
    votes: {},
    selectedPolicies: [],
    nominatedChancellor: null
  };
  
  // Assign roles to players
  shuffledPlayers.forEach((player, index) => {
    gameState.players[player.id] = {
      ...player,
      role: roles[index],
      alive: true,
      investigated: false
    };
  });
  
  // Add initial log
  gameState.log.push({
    time: Date.now(),
    message: 'Game started! Good luck!'
  });
  
  await roomRef.update({ status: 'playing' });
  gameRef = db.ref(`secretSpy/games/${roomCode}`);
  await gameRef.set(gameState);
};

function assignRoles(playerCount) {
  const dist = ROLE_DISTRIBUTION[playerCount];
  const roles = [
    ...Array(dist.loyalists).fill('loyalist'),
    ...Array(dist.spies).fill('spy'),
    'secretSpy'
  ];
  return shuffleArray(roles);
}

function shuffleDeck() {
  const deck = [
    ...Array(6).fill('loyalist'),
    ...Array(11).fill('spy')
  ];
  return shuffleArray(deck);
}

function shuffleArray(array) {
  const arr = [...array];
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/* ---------------- Start Game View ---------------- */
function startGame() {
  waitingScreen.classList.add('hidden');
  gameScreen.classList.remove('hidden');
  document.getElementById('gameRoomCode').textContent = roomCode;
  
  gameRef = db.ref(`secretSpy/games/${roomCode}`);
  gameRef.on('value', handleGameUpdate);
}

/* ---------------- Handle Game Updates ---------------- */
let currentGameState = null;

function handleGameUpdate(snapshot) {
  const game = snapshot.val();
  if (!game) return;
  
  currentGameState = game;
  const myPlayer = game.players[myPCID];
  
  if (!myPlayer) return;
  
  // Display role
  displayRole(myPlayer, game.players);
  
  // Update board
  updateBoard(game);
  
  // Update game status
  updateGameStatus(game, myPlayer);
  
  // Update players display
  updatePlayersDisplay(game);
  
  // Update game log
  updateGameLog(game.log || []);
  
  // Handle phases
  handleGamePhase(game, myPlayer);
  
  // Check win conditions
  checkWinConditions(game);
}

function displayRole(myPlayer, allPlayers) {
  const roleDisplay = document.getElementById('roleDisplay');
  
  let roleHTML = '';
  
  if (myPlayer.role === 'loyalist') {
    roleHTML = `
      <div class="role-card loyalist">
        <div>Your Role: LOYALIST ‚úì</div>
        <div style="font-size:0.7em; margin-top:10px;">Pass 5 Loyalist policies to win!</div>
      </div>
    `;
  } else if (myPlayer.role === 'spy') {
    const otherSpies = Object.values(allPlayers).filter(p => 
      p.role === 'spy' && p.id !== myPCID
    ).map(p => p.name);
    
    roleHTML = `
      <div class="role-card spy">
        <div>Your Role: SPY ‚úó</div>
        <div style="font-size:0.7em; margin-top:10px;">Pass 6 Spy policies or kill the Secret Spy!</div>
        ${otherSpies.length > 0 ? `<div style="font-size:0.6em; margin-top:10px;">Fellow Spies: ${otherSpies.join(', ')}</div>` : ''}
      </div>
    `;
  } else if (myPlayer.role === 'secretSpy') {
    roleHTML = `
      <div class="role-card secret-spy">
        <div>Your Role: SECRET SPY üëë</div>
        <div style="font-size:0.7em; margin-top:10px;">You're a spy but other spies don't know you!</div>
        <div style="font-size:0.7em;">If you're killed by execution, spies win!</div>
      </div>
    `;
  }
  
  roleDisplay.innerHTML = roleHTML;
}

function updateBoard(game) {
  // Update loyalist track
  const loyalistTrack = document.getElementById('loyalistTrack');
  loyalistTrack.querySelectorAll('.track-slot').forEach((slot, index) => {
    if (index < game.loyalistPolicies) {
      slot.classList.add('filled', 'loyalist');
      slot.textContent = '‚úì';
    } else {
      slot.classList.remove('filled', 'loyalist');
      slot.textContent = '';
    }
  });
  
  // Update spy track
  const spyTrack = document.getElementById('spyTrack');
  spyTrack.querySelectorAll('.track-slot').forEach((slot, index) => {
    if (index < game.spyPolicies) {
      slot.classList.add('filled', 'spy');
      slot.textContent = '‚úó';
    } else {
      slot.classList.remove('filled', 'spy');
      slot.textContent = '';
    }
  });
}

function updateGameStatus(game, myPlayer) {
  const statusDiv = document.getElementById('gameStatus');
  const president = game.players[game.currentPresident];
  const chancellor = game.currentChancellor ? game.players[game.currentChancellor] : null;
  
  let statusText = `<strong>Round ${game.round}</strong><br>`;
  statusText += `President: ${president.name}`;
  if (chancellor) {
    statusText += ` | Chancellor: ${chancellor.name}`;
  }
  statusText += `<br>Phase: ${game.phase}`;
  
  if (game.failedVotes > 0) {
    statusText += ` | Failed votes: ${game.failedVotes}/3`;
  }
  
  statusDiv.innerHTML = statusText;
}

function updatePlayersDisplay(game) {
  const playersDiv = document.getElementById('gamePlayers');
  playersDiv.innerHTML = '';
  
  Object.values(game.players).forEach(player => {
    const div = document.createElement('div');
    div.className = 'player-card';
    
    if (player.id === game.currentPresident) {
      div.classList.add('president');
    }
    if (player.id === game.currentChancellor) {
      div.classList.add('chancellor');
    }
    if (!player.alive) {
      div.classList.add('dead');
    }
    
    let html = `<div class="player-name">${player.name}</div>`;
    
    if (player.id === game.currentPresident) {
      html += '<div class="player-role">üìú President</div>';
    }
    if (player.id === game.currentChancellor) {
      html += '<div class="player-role">üèõÔ∏è Chancellor</div>';
    }
    if (!player.alive) {
      html += '<div class="player-role">üíÄ Dead</div>';
    }
    
    div.innerHTML = html;
    playersDiv.appendChild(div);
  });
}

function updateGameLog(log) {
  const logDiv = document.getElementById('gameLog');
  logDiv.innerHTML = '';
  
  [...log].reverse().slice(0, 20).forEach(entry => {
    const div = document.createElement('div');
    div.className = 'log-entry';
    div.textContent = entry.message;
    logDiv.appendChild(div);
  });
}

/* ---------------- Game Phase Handling ---------------- */
function handleGamePhase(game, myPlayer) {
  // Hide all action sections
  document.getElementById('presidentNomination').classList.add('hidden');
  document.getElementById('votingSection').classList.add('hidden');
  document.getElementById('presidentPolicySelect').classList.add('hidden');
  document.getElementById('chancellorPolicySelect').classList.add('hidden');
  document.getElementById('executiveAction').classList.add('hidden');
  
  if (game.phase === 'nomination' && game.currentPresident === myPCID) {
    showPresidentNomination(game);
  } else if (game.phase === 'voting') {
    showVoting(game);
  } else if (game.phase === 'presidentPolicy' && game.currentPresident === myPCID) {
    showPresidentPolicySelect(game);
  } else if (game.phase === 'chancellorPolicy' && game.currentChancellor === myPCID) {
    showChancellorPolicySelect(game);
  } else if (game.phase === 'executiveAction' && game.currentPresident === myPCID) {
    showExecutiveAction(game);
  }
}

/* ---------------- President Nomination ---------------- */
let selectedNominee = null;

function showPresidentNomination(game) {
  document.getElementById('presidentNomination').classList.remove('hidden');
  
  const playersDiv = document.getElementById('nominationPlayers');
  playersDiv.innerHTML = '';
  selectedNominee = null;
  
  Object.values(game.players).forEach(player => {
    if (player.id === myPCID || !player.alive) return;
    
    // Can't nominate last government
    if (Object.keys(game.players).length > 5) {
      if (player.id === game.lastChancellor) return;
      if (player.id === game.lastPresident && game.lastChancellor) return;
    } else {
      if (player.id === game.lastChancellor) return;
    }
    
    const div = document.createElement('div');
    div.className = 'player-card';
    div.innerHTML = `<div class="player-name">${player.name}</div>`;
    div.onclick = () => {
      playersDiv.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
      div.classList.add('selected');
      selectedNominee = player.id;
      document.getElementById('nominateBtn').disabled = false;
    };
    playersDiv.appendChild(div);
  });
}

document.getElementById('nominateBtn').onclick = async () => {
  if (!selectedNominee) return;
  
  await gameRef.update({
    nominatedChancellor: selectedNominee,
    phase: 'voting',
    votes: {}
  });
  
  await addLog(`${currentGameState.players[myPCID].name} nominated ${currentGameState.players[selectedNominee].name} for Chancellor`);
};

/* ---------------- Voting ---------------- */
function showVoting(game) {
  document.getElementById('votingSection').classList.remove('hidden');
  
  const president = game.players[game.currentPresident];
  const nominee = game.players[game.nominatedChancellor];
  
  document.getElementById('votingPrompt').textContent = 
    `${president.name} nominated ${nominee.name} for Chancellor`;
  
  // Check if already voted
  if (game.votes && game.votes[myPCID] !== undefined) {
    document.getElementById('voteYesBtn').disabled = true;
    document.getElementById('voteNoBtn').disabled = true;
  } else {
    document.getElementById('voteYesBtn').disabled = false;
    document.getElementById('voteNoBtn').disabled = false;
  }
}

document.getElementById('voteYesBtn').onclick = () => castVote(true);
document.getElementById('voteNoBtn').onclick = () => castVote(false);

async function castVote(vote) {
  await gameRef.child(`votes/${myPCID}`).set(vote);
  
  document.getElementById('voteYesBtn').disabled = true;
  document.getElementById('voteNoBtn').disabled = true;
  
  // Check if all players voted
  setTimeout(checkVotingComplete, 500);
}

async function checkVotingComplete() {
  const snapshot = await gameRef.once('value');
  const game = snapshot.val();
  
  const alivePlayers = Object.values(game.players).filter(p => p.alive);
  const votes = game.votes || {};
  
  if (Object.keys(votes).length === alivePlayers.length) {
    // Count votes
    const yesVotes = Object.values(votes).filter(v => v).length;
    const noVotes = Object.values(votes).filter(v => !v).length;
    
    if (yesVotes > noVotes) {
      // Government elected
      await gameRef.update({
        currentChancellor: game.nominatedChancellor,
        phase: 'presidentPolicy',
        failedVotes: 0,
        lastPresident: game.currentPresident,
        lastChancellor: game.nominatedChancellor
      });
      
      await addLog(`Vote passed! ${yesVotes} Ja, ${noVotes} Nein`);
      
      // Draw 3 policies
      const newDeck = [...game.deck];
      const drawnPolicies = newDeck.splice(0, 3);
      
      await gameRef.update({
        deck: newDeck,
        selectedPolicies: drawnPolicies
      });
      
    } else {
      // Government rejected
      const newFailedVotes = game.failedVotes + 1;
      
      await addLog(`Vote failed! ${yesVotes} Ja, ${noVotes} Nein`);
      
      if (newFailedVotes >= 3) {
        // Chaos - enact top policy
        const newDeck = [...game.deck];
        const topPolicy = newDeck.shift();
        
        await addLog(`CHAOS! Top policy enacted: ${topPolicy === 'loyalist' ? 'Loyalist ‚úì' : 'Spy ‚úó'}`);
        
        if (topPolicy === 'loyalist') {
          await gameRef.update({
            loyalistPolicies: game.loyalistPolicies + 1,
            deck: newDeck,
            failedVotes: 0
          });
        } else {
          await gameRef.update({
            spyPolicies: game.spyPolicies + 1,
            deck: newDeck,
            failedVotes: 0
          });
        }
        
        nextRound();
      } else {
        await gameRef.update({
          failedVotes: newFailedVotes
        });
        
        nextRound();
      }
    }
  }
}

/* ---------------- Policy Selection ---------------- */
let selectedPolicies = [];

function showPresidentPolicySelect(game) {
  document.getElementById('presidentPolicySelect').classList.remove('hidden');
  
  const policiesDiv = document.getElementById('presidentPolicies');
  policiesDiv.innerHTML = '';
  selectedPolicies = [];
  
  game.selectedPolicies.forEach((policy, index) => {
    const div = document.createElement('div');
    div.className = `policy-card ${policy}-policy`;
    div.textContent = policy === 'loyalist' ? '‚úì' : '‚úó';
    div.onclick = () => {
      if (selectedPolicies.includes(index)) {
        selectedPolicies = selectedPolicies.filter(i => i !== index);
        div.classList.remove('selected');
      } else if (selectedPolicies.length < 2) {
        selectedPolicies.push(index);
        div.classList.add('selected');
      }
      
      document.getElementById('presidentPassBtn').disabled = selectedPolicies.length !== 2;
    };
    policiesDiv.appendChild(div);
  });
}

document.getElementById('presidentPassBtn').onclick = async () => {
  const game = currentGameState;
  const keptPolicies = selectedPolicies.map(i => game.selectedPolicies[i]);
  const discardedPolicy = game.selectedPolicies.find((p, i) => !selectedPolicies.includes(i));
  
  await gameRef.update({
    selectedPolicies: keptPolicies,
    discard: [...game.discard, discardedPolicy],
    phase: 'chancellorPolicy'
  });
  
  await addLog('President passed 2 policies to Chancellor');
};

function showChancellorPolicySelect(game) {
  document.getElementById('chancellorPolicySelect').classList.remove('hidden');
  
  const policiesDiv = document.getElementById('chancellorPolicies');
  policiesDiv.innerHTML = '';
  let selectedPolicy = null;
  
  game.selectedPolicies.forEach((policy, index) => {
    const div = document.createElement('div');
    div.className = `policy-card ${policy}-policy`;
    div.textContent = policy === 'loyalist' ? '‚úì' : '‚úó';
    div.onclick = () => {
      policiesDiv.querySelectorAll('.policy-card').forEach(c => c.classList.remove('selected'));
      div.classList.add('selected');
      selectedPolicy = index;
      document.getElementById('chancellorEnactBtn').disabled = false;
    };
    policiesDiv.appendChild(div);
  });
  
  document.getElementById('chancellorEnactBtn').onclick = async () => {
    const enactedPolicy = game.selectedPolicies[selectedPolicy];
    const discardedPolicy = game.selectedPolicies[1 - selectedPolicy];
    
    await addLog(`Chancellor enacted a ${enactedPolicy === 'loyalist' ? 'Loyalist ‚úì' : 'Spy ‚úó'} policy`);
    
    const updates = {
      discard: [...game.discard, discardedPolicy],
      selectedPolicies: []
    };
    
    if (enactedPolicy === 'loyalist') {
      updates.loyalistPolicies = game.loyalistPolicies + 1;
      updates.phase = 'nomination';
      nextRound();
    } else {
      updates.spyPolicies = game.spyPolicies + 1;
      
      // Check for executive action
      const spyCount = game.spyPolicies + 1;
      const playerCount = Object.keys(game.players).length;
      
      if ((playerCount <= 6 && spyCount === 3) || 
          (playerCount <= 8 && (spyCount === 2 || spyCount === 3)) ||
          (playerCount >= 9 && (spyCount === 1 || spyCount === 2 || spyCount === 3))) {
        updates.phase = 'executiveAction';
        updates.executiveActionType = getExecutiveAction(playerCount, spyCount);
      } else {
        updates.phase = 'nomination';
        nextRound();
      }
    }
    
    await gameRef.update(updates);
  };
}

function getExecutiveAction(playerCount, spyPolicies) {
  if (playerCount <= 6) {
    if (spyPolicies === 3) return 'investigate';
  } else if (playerCount <= 8) {
    if (spyPolicies === 2) return 'investigate';
    if (spyPolicies === 3) return 'execution';
  } else {
    if (spyPolicies === 1 || spyPolicies === 2) return 'investigate';
    if (spyPolicies === 3) return 'execution';
  }
  return null;
}

/* ---------------- Executive Actions ---------------- */
let selectedExecutiveTarget = null;

function showExecutiveAction(game) {
  document.getElementById('executiveAction').classList.remove('hidden');
  
  const actionType = game.executiveActionType;
  let title = '';
  
  if (actionType === 'investigate') {
    title = 'Investigate a player\'s loyalty';
  } else if (actionType === 'execution') {
    title = 'Execute a player';
  }
  
  document.getElementById('executiveActionTitle').textContent = title;
  
  const playersDiv = document.getElementById('executivePlayers');
  playersDiv.innerHTML = '';
  selectedExecutiveTarget = null;
  
  Object.values(game.players).forEach(player => {
    if (player.id === myPCID || !player.alive) return;
    if (actionType === 'investigate' && player.investigated) return;
    
    const div = document.createElement('div');
    div.className = 'player-card';
    div.innerHTML = `<div class="player-name">${player.name}</div>`;
    div.onclick = () => {
      playersDiv.querySelectorAll('.player-card').forEach(c => c.classList.remove('selected'));
      div.classList.add('selected');
      selectedExecutiveTarget = player.id;
      document.getElementById('executeActionBtn').disabled = false;
    };
    playersDiv.appendChild(div);
  });
}

document.getElementById('executeActionBtn').onclick = async () => {
  if (!selectedExecutiveTarget) return;
  
  const game = currentGameState;
  const target = game.players[selectedExecutiveTarget];
  
  if (game.executiveActionType === 'investigate') {
    const loyalty = target.role === 'loyalist' ? 'Loyalist' : 'Spy';
    alert(`${target.name} is a ${loyalty}!`);
    
    await gameRef.child(`players/${selectedExecutiveTarget}`).update({ investigated: true });
    await addLog(`President investigated ${target.name}`);
    
    nextRound();
    
  } else if (game.executiveActionType === 'execution') {
    await gameRef.child(`players/${selectedExecutiveTarget}`).update({ alive: false });
    await addLog(`President executed ${target.name}!`);
    
    // Check if Secret Spy was killed
    if (target.role === 'secretSpy') {
      await gameRef.update({
        winner: 'spies',
        phase: 'gameOver'
      });
      return;
    }
    
    nextRound();
  }
};

/* ---------------- Helper Functions ---------------- */
async function nextRound() {
  const snapshot = await gameRef.once('value');
  const game = snapshot.val();
  
  const alivePlayers = Object.values(game.players).filter(p => p.alive);
  const currentPresidentIdx = alivePlayers.findIndex(p => p.id === game.currentPresident);
  const nextPresidentIdx = (currentPresidentIdx + 1) % alivePlayers.length;
  const nextPresident = alivePlayers[nextPresidentIdx].id;
  
  // Reshuffle if deck is low
  let newDeck = [...game.deck];
  if (newDeck.length < 3) {
    newDeck = [...newDeck, ...game.discard];
    newDeck = shuffleArray(newDeck);
    await gameRef.update({ discard: [] });
  }
  
  await gameRef.update({
    round: game.round + 1,
    currentPresident: nextPresident,
    currentChancellor: null,
    nominatedChancellor: null,
    phase: 'nomination',
    votes: {},
    deck: newDeck
  });
}

async function addLog(message) {
  const snapshot = await gameRef.child('log').once('value');
  const log = snapshot.val() || [];
  
  log.push({
    time: Date.now(),
    message: message
  });
  
  await gameRef.child('log').set(log);
}

/* ---------------- Win Conditions ---------------- */
function checkWinConditions(game) {
  if (game.loyalistPolicies >= 5) {
    endGame('loyalists', 'Loyalists win! 5 Loyalist policies passed! ‚úì');
  } else if (game.spyPolicies >= 6) {
    endGame('spies', 'Spies win! 6 Spy policies passed! ‚úó');
  } else if (game.winner === 'spies') {
    endGame('spies', 'Spies win! The Secret Spy was executed! üëë');
  }
}

async function endGame(winner, message) {
  if (currentGameState.phase === 'gameOver') {
    displayGameOver(winner, message);
    return;
  }
  
  await gameRef.update({
    phase: 'gameOver',
    winner: winner
  });
}

function displayGameOver(winner, message) {
  gameScreen.classList.add('hidden');
  gameOverScreen.classList.remove('hidden');
  
  const myPlayer = currentGameState.players[myPCID];
  const didWin = (winner === 'loyalists' && myPlayer.role === 'loyalist') ||
                 (winner === 'spies' && (myPlayer.role === 'spy' || myPlayer.role === 'secretSpy'));
  
  document.getElementById('gameOverTitle').textContent = didWin ? 'üéâ Victory! üéâ' : 'üòî Defeat';
  
  const messageDiv = document.getElementById('gameOverMessage');
  messageDiv.textContent = message;
  messageDiv.className = 'role-card ' + (winner === 'loyalists' ? 'loyalist' : 'spy');
  
  // Show all roles
  const rolesDiv = document.getElementById('finalRoles');
  let rolesHTML = '<h3>Player Roles</h3><div class="player-list">';
  
  Object.values(currentGameState.players).forEach(player => {
    const roleIcon = player.role === 'loyalist' ? '‚úì' : (player.role === 'secretSpy' ? 'üëë' : '‚úó');
    const roleColor = player.role === 'loyalist' ? '#4CAF50' : '#f44336';
    rolesHTML += `
      <div class="player-card">
        <div class="player-name">${player.name}</div>
        <div class="player-role" style="color:${roleColor};">${roleIcon} ${player.role.toUpperCase()}</div>
      </div>
    `;
  });
  
  rolesHTML += '</div>';
  rolesDiv.innerHTML = rolesHTML;
}

/* ---------------- Leave/New Game ---------------- */
leaveRoomBtn.onclick = () => {
  if (roomRef) roomRef.off();
  returnToLobby();
};

leaveGameBtn.onclick = () => {
  if (gameRef) gameRef.off();
  if (roomRef) roomRef.off();
  returnToLobby();
};

document.getElementById('newGameBtn').onclick = () => {
  if (gameRef) gameRef.off();
  if (roomRef) roomRef.off();
  returnToLobby();
};

function returnToLobby() {
  lobbyScreen.classList.remove('hidden');
  waitingScreen.classList.add('hidden');
  gameScreen.classList.add('hidden');
  gameOverScreen.classList.add('hidden');
  
  roomCode = null;
  roomRef = null;
  gameRef = null;
  myPlayerData = null;
  currentGameState = null;
}
</script>

</body>
</html>